{% extends "base.html" %}

{% block title %}{{ problem.title }} - TCS Open Problems{% endblock %}

{% block content %}
<article class="problem-detail">
    <div class="problem-header">
        <div class="vote-section">
            {% if current_user %}
                <form action="{{ url_for('vote', id=problem.id) }}" method="POST">
                    <button type="submit" class="vote-btn vote-btn-small {% if has_voted %}voted{% endif %}">
                        <span class="vote-arrow">&#9650;</span>
                        <span class="vote-count">{{ vote_count }}</span>
                    </button>
                </form>
            {% else %}
                <div class="vote-btn vote-btn-small disabled">
                    <span class="vote-arrow">&#9650;</span>
                    <span class="vote-count">{{ vote_count }}</span>
                </div>
            {% endif %}
        </div>
        <div class="problem-header-content">
            <h1>{{ problem.title }}</h1>
            {% if categories %}
                <div class="categories">
                    {% for cat in categories %}
                        <a href="{{ url_for('category', name=cat.name) }}" class="category">{{ cat.name }}</a>
                    {% endfor %}
                </div>
            {% endif %}
            <div class="meta">
                <span>by {{ problem.username }}</span>
                <span>{{ problem.created_at[:10] }}</span>
            </div>
        </div>
        <div class="problem-stats">
            <div class="ratings-display large">
                <div class="rating-item">
                    <span class="rating-label">Impact</span>
                    <span class="rating-value">{% if avg_ratings.avg_impact %}{{ avg_ratings.avg_impact }}{% else %}-{% endif %}</span>
                </div>
                <div class="rating-item">
                    <span class="rating-label">Solvability</span>
                    <span class="rating-value">{% if avg_ratings.avg_solvability %}{{ avg_ratings.avg_solvability }}{% else %}-{% endif %}</span>
                </div>
                {% if avg_ratings.count > 0 %}
                    <span class="rating-count">({{ avg_ratings.count }} rating{% if avg_ratings.count != 1 %}s{% endif %})</span>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="description">
        {{ problem.description | markdown }}
    </div>

    {% if current_user and current_user.id == problem.user_id %}
    <div class="admin-actions">
        <a href="{{ url_for('edit_problem', id=problem.id) }}" class="btn-small">Edit Problem</a>
        {% if is_admin %}
        <form action="{{ url_for('admin_delete_problem', id=problem.id) }}" method="POST" class="inline" onsubmit="return confirm('Are you sure you want to delete this problem? This cannot be undone.');">
            <button type="submit" class="btn-small btn-danger">Delete Problem</button>
        </form>
        {% endif %}
    </div>
    {% elif is_admin %}
    <div class="admin-actions">
        <a href="{{ url_for('admin_edit_problem', id=problem.id) }}" class="btn-small">Edit Problem</a>
        <form action="{{ url_for('admin_delete_problem', id=problem.id) }}" method="POST" class="inline" onsubmit="return confirm('Are you sure you want to delete this problem? This cannot be undone.');">
            <button type="submit" class="btn-small btn-danger">Delete Problem</button>
        </form>
    </div>
    {% endif %}
</article>

{% if current_user %}
<section class="rating-section">
    <h2>Rate This Problem</h2>
    <form class="rating-form" action="{{ url_for('rate', id=problem.id) }}" method="POST">
        <div class="rating-inputs">
            <div class="rating-input-group">
                <label for="impact">Impact (1-5)</label>
                <p class="rating-hint">How significant would solving this problem be?</p>
                <ul class="rating-guide">
                    <li><strong>1:</strong> Curious result, but not likely to be publishable</li>
                    <li><strong>3:</strong> Publishable at a decent conference</li>
                    <li><strong>5:</strong> Top result in the area in the past few years</li>
                </ul>
                <select name="impact" id="impact" required>
                    <option value="">Select...</option>
                    {% for i in range(1, 6) %}
                        <option value="{{ i }}" {% if user_rating and user_rating.impact == i %}selected{% endif %}>{{ i }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="rating-input-group">
                <label for="solvability">Solvability (1-5)</label>
                <p class="rating-hint">Could a PhD student make substantial progress?</p>
                <ul class="rating-guide">
                    <li><strong>1:</strong> Plausibly, if you spent your PhD on the problem</li>
                    <li><strong>3:</strong> Plausibly, within a year</li>
                    <li><strong>5:</strong> Good problem for an undergraduate</li>
                </ul>
                <select name="solvability" id="solvability" required>
                    <option value="">Select...</option>
                    {% for i in range(1, 6) %}
                        <option value="{{ i }}" {% if user_rating and user_rating.solvability == i %}selected{% endif %}>{{ i }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <button type="submit">{% if user_rating %}Update Rating{% else %}Submit Rating{% endif %}</button>
    </form>
    {% if user_rating %}
        <p class="your-rating">Your current rating: Impact {{ user_rating.impact }}, Solvability {{ user_rating.solvability }}</p>
    {% endif %}
</section>
{% else %}
<section class="rating-section">
    <p class="login-prompt"><a href="{{ url_for('login') }}">Log in</a> to rate this problem.</p>
</section>
{% endif %}

<section class="discussion">
    <h2>Discussion ({{ comments|length }})</h2>

    {% if comments %}
        <div class="comments">
            {% for comment in comments %}
            <div class="comment">
                <div class="comment-header">
                    <strong>{{ comment.username }}</strong>
                    <span class="comment-date">{{ comment.created_at[:16] }}</span>
                    {% if is_admin %}
                    <span class="admin-comment-actions">
                        <a href="{{ url_for('admin_edit_comment', id=comment.id) }}" class="btn-small">Edit</a>
                        <form action="{{ url_for('admin_delete_comment', id=comment.id) }}" method="POST" class="inline" onsubmit="return confirm('Delete this comment?');">
                            <button type="submit" class="btn-small btn-danger">Delete</button>
                        </form>
                    </span>
                    {% endif %}
                </div>
                <p>{{ comment.content }}</p>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <p class="no-comments">No comments yet. Start the discussion!</p>
    {% endif %}

    {% if current_user %}
    <form class="comment-form" action="{{ url_for('add_comment', id=problem.id) }}" method="POST">
        <h3>Add a Comment</h3>
        <textarea name="content" placeholder="Share your thoughts, partial solutions, or related ideas..." required rows="4"></textarea>
        <button type="submit">Post Comment</button>
    </form>
    {% else %}
    <div class="login-prompt">
        <p><a href="{{ url_for('login') }}">Log in</a> to join the discussion.</p>
    </div>
    {% endif %}
</section>

<a href="{{ url_for('index') }}" class="back-link">&larr; Back to all problems</a>
{% endblock %}

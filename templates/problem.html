{% extends "base.html" %}

{% block title %}{{ problem.title }} - Open Problems{% endblock %}

{% block content %}
<article class="problem-detail">
    <div class="problem-header">
        <div class="problem-header-content">
            <h1>{{ problem.title }}</h1>
            {% if categories %}
                <div class="categories">
                    {% for cat in categories %}
                        <a href="{{ url_for('category', name=cat.name) }}" class="category">{{ cat.name }}</a>
                    {% endfor %}
                </div>
            {% endif %}
            <div class="meta">
                <span>by {{ problem.username }}</span>
                <span>{{ problem.created_at[:10] }}</span>
            </div>
        </div>
        <div class="problem-stats">
            <div class="ratings-display large">
                <div class="rating-item">
                    <span class="rating-label">Impact</span>
                    <span class="rating-value">{% if avg_ratings.avg_impact %}{{ avg_ratings.avg_impact }}{% else %}-{% endif %}</span>
                </div>
                <div class="rating-item">
                    <span class="rating-label">Solvability</span>
                    <span class="rating-value">{% if avg_ratings.avg_solvability %}{{ avg_ratings.avg_solvability }}{% else %}-{% endif %}</span>
                </div>
                {% if avg_ratings.count > 0 %}
                    <span class="rating-count">({{ avg_ratings.count }} rating{% if avg_ratings.count != 1 %}s{% endif %})</span>
                {% endif %}
            </div>
            <div class="vote-section large">
                {% if current_user %}
                    <form action="{{ url_for('vote', id=problem.id) }}" method="POST">
                        <button type="submit" class="vote-btn {% if has_voted %}voted{% endif %}">
                            <span class="vote-arrow">&#9650;</span>
                            <span class="vote-count">{{ vote_count }}</span>
                        </button>
                    </form>
                {% else %}
                    <div class="vote-btn disabled">
                        <span class="vote-arrow">&#9650;</span>
                        <span class="vote-count">{{ vote_count }}</span>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="description">
        {{ problem.description | safe }}
    </div>
</article>

{% if current_user %}
<section class="rating-section">
    <h2>Rate This Problem</h2>
    <form class="rating-form" action="{{ url_for('rate', id=problem.id) }}" method="POST">
        <div class="rating-inputs">
            <div class="rating-input-group">
                <label for="impact">Impact (1-5)</label>
                <p class="rating-hint">How significant would solving this problem be?</p>
                <select name="impact" id="impact" required>
                    <option value="">Select...</option>
                    {% for i in range(1, 6) %}
                        <option value="{{ i }}" {% if user_rating and user_rating.impact == i %}selected{% endif %}>{{ i }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="rating-input-group">
                <label for="solvability">Solvability (1-5)</label>
                <p class="rating-hint">How likely is this problem to be solved soon?</p>
                <select name="solvability" id="solvability" required>
                    <option value="">Select...</option>
                    {% for i in range(1, 6) %}
                        <option value="{{ i }}" {% if user_rating and user_rating.solvability == i %}selected{% endif %}>{{ i }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <button type="submit">{% if user_rating %}Update Rating{% else %}Submit Rating{% endif %}</button>
    </form>
    {% if user_rating %}
        <p class="your-rating">Your current rating: Impact {{ user_rating.impact }}, Solvability {{ user_rating.solvability }}</p>
    {% endif %}
</section>
{% else %}
<section class="rating-section">
    <p class="login-prompt"><a href="{{ url_for('login') }}">Log in</a> to rate this problem.</p>
</section>
{% endif %}

<section class="discussion">
    <h2>Discussion ({{ comments|length }})</h2>

    {% if comments %}
        <div class="comments">
            {% for comment in comments %}
            <div class="comment">
                <div class="comment-header">
                    <strong>{{ comment.username }}</strong>
                    <span class="comment-date">{{ comment.created_at[:16] }}</span>
                </div>
                <p>{{ comment.content }}</p>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <p class="no-comments">No comments yet. Start the discussion!</p>
    {% endif %}

    {% if current_user %}
    <form class="comment-form" action="{{ url_for('add_comment', id=problem.id) }}" method="POST">
        <h3>Add a Comment</h3>
        <textarea name="content" placeholder="Share your thoughts, partial solutions, or related ideas..." required rows="4"></textarea>
        <button type="submit">Post Comment</button>
    </form>
    {% else %}
    <div class="login-prompt">
        <p><a href="{{ url_for('login') }}">Log in</a> to join the discussion.</p>
    </div>
    {% endif %}
</section>

<a href="{{ url_for('index') }}" class="back-link">&larr; Back to all problems</a>
{% endblock %}
